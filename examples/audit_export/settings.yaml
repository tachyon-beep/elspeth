# Example: Pipeline with audit export to JSON
#
# This demonstrates ELSPETH's audit trail export feature for compliance
# and legal inquiry. After a run completes, the full audit trail is
# exported to a JSON sink for review.
#
# Note: Uses JSON format because audit records are heterogeneous (run, node,
# row, token records have different fields). For CSV export, separate files
# per record type would be needed.
#
# Run with:
#   uv run elspeth run -s examples/audit_export/settings.yaml --execute
#
# For signed exports (legal/compliance use):
#   export ELSPETH_SIGNING_KEY="your-secret-key"
#   # Then update sign: true below
#   uv run elspeth run -s examples/audit_export/settings.yaml --execute

datasource:
  plugin: csv
  options:
    path: examples/audit_export/input.csv
    schema:
      fields: dynamic  # Accept any fields from CSV
    on_validation_failure: discard  # or a sink name for quarantine

# Config-driven gate: Route corporate submissions to a dedicated sink.
# Route labels must be "true"/"false" for boolean conditions
gates:
  - name: category_router
    condition: "row['category'] == 'corporate'"
    routes:
      "true": corporate     # condition true -> corporate sink
      "false": continue     # condition false -> continue to non_corporate (output_sink)

sinks:
  non_corporate:
    plugin: csv
    options:
      path: examples/audit_export/output/non_corporate.csv
      schema:
        fields: dynamic

  corporate:
    plugin: csv
    options:
      path: examples/audit_export/output/corporate.csv
      schema:
        fields: dynamic

  # Export sink for compliance audit trail (uses JSON for heterogeneous records)
  audit_export:
    plugin: json
    options:
      path: examples/audit_export/output/audit_trail.json
      schema:
        fields: dynamic

output_sink: non_corporate

# Audit trail configuration
landscape:
  url: sqlite:///examples/audit_export/runs/audit.db
  export:
    enabled: true
    sink: audit_export
    format: json  # Use JSON - audit records have varying schemas per record_type
    sign: false   # Set to true and provide ELSPETH_SIGNING_KEY for legal use
