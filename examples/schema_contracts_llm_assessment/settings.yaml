source:
  plugin: csv
  on_success: source_out
  options:
    path: examples/schema_contracts_llm_assessment/input.csv
    schema:
      mode: observed
    normalize_fields: true
    on_validation_failure: discard
transforms:
- name: openrouter_multi_query_llm_0
  plugin: openrouter_multi_query_llm
  input: source_out
  on_success: output
  options:
    model: anthropic/claude-3-5-sonnet
    api_key: ${OPENROUTER_API_KEY}
    system_prompt: 'You are a medical assessment AI. For each case study and criterion,

      provide a score (0-100) and rationale. Respond ONLY in JSON format:

      {"score": <number>, "rationale": "<explanation>"}

      '
    template: '## Case Study

      **Background:** {{ row.input_1 }}

      **Symptoms:** {{ row.input_2 }}

      **History:** {{ row.input_3 }}


      ## Evaluation Criterion: {{ row.criterion.name }}

      {{ row.criterion.description }}


      {% if row.criterion.subcriteria %}

      Consider these subcriteria:

      {% for sub in row.criterion.subcriteria %}

      - {{ sub }}

      {% endfor %}

      {% endif %}


      Provide your assessment.

      '
    lookup_file: criteria_lookup.yaml
    required_input_fields: []
    case_studies:
    - name: cs1
      input_fields:
      - case_study_1_background_info
      - cs1_symptoms_signs
      - cs1_medical_history
    - name: cs2
      input_fields:
      - case_study_2_background_info
      - cs2_symptoms_signs
      - cs2_medical_history
    criteria:
    - name: diagnosis
      code: DIAG
      description: Assess the accuracy and completeness of the diagnosis
      subcriteria:
      - Correct primary diagnosis
      - Appropriate differential diagnoses considered
      - Evidence-based reasoning
    - name: treatment
      code: TREAT
      description: Assess the appropriateness of the treatment plan
      subcriteria:
      - Guideline-concordant treatment
      - Patient-specific considerations
      - Risk-benefit analysis
    - name: prognosis
      code: PROG
      description: Assess the accuracy of prognostic assessment
      subcriteria:
      - Realistic timeline
      - Key prognostic factors identified
      - Clear communication
    response_format: standard
    output_mapping:
      score:
        suffix: score
        type: integer
      rationale:
        suffix: rationale
        type: string
    pool_size: 5
    temperature: 0.0
    max_tokens: 500
    schema:
      mode: observed
sinks:
  output:
    plugin: csv
    options:
      path: examples/schema_contracts_llm_assessment/output/results.csv
      schema:
        mode: observed
landscape:
  url: sqlite:///examples/schema_contracts_llm_assessment/runs/audit.db
