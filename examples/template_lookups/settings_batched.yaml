landscape:
  url: sqlite:///examples/template_lookups/runs/audit_batched.db
source:
  plugin: csv
  options:
    path: examples/template_lookups/input.csv
    on_validation_failure: discard
    schema:
      mode: fixed
      fields:
      - 'ticket_id: str'
      - 'category_id: str'
      - 'priority_id: str'
      - 'subject: str'
      - 'body: str'
    on_success: output
aggregations:
- name: classify_batch
  plugin: openrouter_batch_llm
  trigger:
    count: 5
  output_mode: passthrough
  options:
    model: anthropic/claude-3-haiku
    api_key: ${OPENROUTER_API_KEY}
    template_file: prompts/classify.j2
    lookup_file: prompts/categories.yaml
    system_prompt: 'You are a precise customer support ticket classifier.

      Always respond with valid JSON matching the requested format.

      Be concise but accurate in your analysis.

      '
    temperature: 0.1
    max_tokens: 500
    response_field: classification
    required_input_fields:
    - ticket_id
    - category_id
    - priority_id
    - subject
    - body
    schema:
      mode: observed
    pool_size: 3
sinks:
  output:
    plugin: json
    options:
      path: examples/template_lookups/output/results_batched.json
      schema:
        mode: observed
      format: jsonl
