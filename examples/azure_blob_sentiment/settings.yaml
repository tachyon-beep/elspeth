source:
  plugin: azure_blob
  options:
    sas_token: ${AZURE_STORAGE_SAS_TOKEN}
    account_url: ${AZURE_STORAGE_ACCOUNT_URL}
    container: ${AZURE_STORAGE_CONTAINER}
    blob_path: input/sentiment_data.csv
    format: csv
    csv_options:
      delimiter: ','
      has_header: true
      encoding: utf-8
    schema:
      mode: fixed
      fields:
      - 'id: int'
      - 'text: str'
    on_validation_failure: discard
    on_success: output
transforms:
- plugin: keyword_filter
  options:
    fields: text
    blocked_patterns:
    - (?i)\bpineapple\b
    on_error: blocked_keywords
    schema:
      mode: observed
- plugin: azure_content_safety
  options:
    endpoint: ${AZURE_CONTENT_SAFETY_ENDPOINT}
    api_key: ${AZURE_CONTENT_SAFETY_KEY}
    fields: text
    thresholds:
      hate: 2
      violence: 2
      sexual: 2
      self_harm: 0
    on_error: flagged
    schema:
      mode: observed
    pool_size: 5
- plugin: azure_prompt_shield
  options:
    endpoint: ${AZURE_CONTENT_SAFETY_ENDPOINT}
    api_key: ${AZURE_CONTENT_SAFETY_KEY}
    fields: text
    on_error: attacks
    schema:
      mode: observed
    pool_size: 5
- plugin: azure_llm
  options:
    deployment_name: ${AZURE_OPENAI_DEPLOYMENT}
    endpoint: ${AZURE_OPENAI_ENDPOINT}
    api_key: ${AZURE_OPENAI_KEY}
    api_version: ${AZURE_OPENAI_API_VERSION}
    template: 'Analyze the sentiment of the following text and respond with ONLY a JSON object.


      Text: {{ row.text }}


      Respond with exactly this format (no other text):

      {"sentiment": "positive" or "negative" or "neutral", "confidence": 0.0-1.0, "summary": "brief explanation"}

      '
    temperature: 0.0
    response_field: sentiment_analysis
    on_error: llm_errors
    schema:
      mode: observed
    pool_size: 10
    on_success: output
sinks:
  output:
    plugin: azure_blob
    options:
      sas_token: ${AZURE_STORAGE_SAS_TOKEN}
      account_url: ${AZURE_STORAGE_ACCOUNT_URL}
      container: ${AZURE_STORAGE_CONTAINER}
      blob_path: output/{{ run_id }}/results.csv
      format: csv
      overwrite: true
      csv_options:
        delimiter: ','
        encoding: utf-8
        include_header: true
      schema:
        mode: observed
  flagged:
    plugin: azure_blob
    options:
      sas_token: ${AZURE_STORAGE_SAS_TOKEN}
      account_url: ${AZURE_STORAGE_ACCOUNT_URL}
      container: ${AZURE_STORAGE_CONTAINER}
      blob_path: output/{{ run_id }}/flagged.csv
      format: csv
      overwrite: true
      csv_options:
        delimiter: ','
        encoding: utf-8
        include_header: true
      schema:
        mode: observed
  attacks:
    plugin: azure_blob
    options:
      sas_token: ${AZURE_STORAGE_SAS_TOKEN}
      account_url: ${AZURE_STORAGE_ACCOUNT_URL}
      container: ${AZURE_STORAGE_CONTAINER}
      blob_path: output/{{ run_id }}/attacks.csv
      format: csv
      overwrite: true
      csv_options:
        delimiter: ','
        encoding: utf-8
        include_header: true
      schema:
        mode: observed
  blocked_keywords:
    plugin: azure_blob
    options:
      sas_token: ${AZURE_STORAGE_SAS_TOKEN}
      account_url: ${AZURE_STORAGE_ACCOUNT_URL}
      container: ${AZURE_STORAGE_CONTAINER}
      blob_path: output/{{ run_id }}/blocked_keywords.csv
      format: csv
      overwrite: true
      csv_options:
        delimiter: ','
        encoding: utf-8
        include_header: true
      schema:
        mode: observed
  llm_errors:
    plugin: azure_blob
    options:
      sas_token: ${AZURE_STORAGE_SAS_TOKEN}
      account_url: ${AZURE_STORAGE_ACCOUNT_URL}
      container: ${AZURE_STORAGE_CONTAINER}
      blob_path: output/{{ run_id }}/llm_errors.csv
      format: csv
      overwrite: true
      csv_options:
        delimiter: ','
        encoding: utf-8
        include_header: true
      schema:
        mode: observed
landscape:
  url: sqlite:///examples/azure_blob_sentiment/runs/audit.db
