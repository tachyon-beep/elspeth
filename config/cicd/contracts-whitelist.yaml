# Types intentionally defined outside contracts/
# These are internal to their module and not used across boundaries
allowed_external_types:
  # TUI display types - presentation-specific, not cross-boundary contracts
  - "tui/types:TokenDisplayInfo"
  # Plugin execution context - framework infrastructure, not a data contract
  - "plugins/context:PluginContext"

# dict[str, Any] patterns that are intentional
# Format: "file_path:context:param_name"
allowed_dict_patterns:
  # ═══════════════════════════════════════════════════════════════════════════
  # ROW DATA (THEIR DATA)
  # User pipeline data is inherently dynamic - we cannot know the schema.
  # These are wrapped in typed containers (TokenInfo) but the row content itself
  # can be anything the user's pipeline produces.
  # ═══════════════════════════════════════════════════════════════════════════

  # Engine - row data handling
  - "src/elspeth/engine/tokens.py:TokenManager.create_initial_token:row_data"
  - "src/elspeth/engine/tokens.py:TokenManager.create_token_for_existing_row:row_data"
  - "src/elspeth/engine/tokens.py:TokenManager.fork_token:row_data"
  - "src/elspeth/engine/tokens.py:TokenManager.coalesce_tokens:merged_data"
  - "src/elspeth/engine/tokens.py:TokenManager.update_row_data:new_data"
  - "src/elspeth/engine/tokens.py:TokenManager.expand_token:expanded_rows (list)"
  - "src/elspeth/engine/processor.py:RowProcessor.process_row:row_data"
  - "src/elspeth/engine/processor.py:RowProcessor.process_existing_row:row_data"
  - "src/elspeth/engine/expression_parser.py:_ExpressionEvaluator.__init__:row"
  - "src/elspeth/engine/expression_parser.py:ExpressionParser.evaluate:row"
  - "src/elspeth/engine/coalesce_executor.py:CoalesceExecutor._merge_data:return"

  # Aggregation executor - checkpoint and state methods
  - "src/elspeth/engine/executors.py:AggregationExecutor.get_buffered_rows:return (list)"
  - "src/elspeth/engine/executors.py:AggregationExecutor.get_checkpoint_state:return"
  - "src/elspeth/engine/executors.py:AggregationExecutor.restore_from_checkpoint:state"
  - "src/elspeth/engine/executors.py:AggregationExecutor.restore_state:state"
  - "src/elspeth/engine/executors.py:AggregationExecutor.get_restored_state:return"

  # Orchestrator - export configuration
  - "src/elspeth/engine/orchestrator.py:Orchestrator._export_landscape:sinks"

  # Protocols - row data in plugin interface
  - "src/elspeth/plugins/protocols.py:TransformProtocol.process:row"
  - "src/elspeth/plugins/protocols.py:GateProtocol.evaluate:row"
  - "src/elspeth/plugins/protocols.py:CoalesceProtocol.merge:return"
  - "src/elspeth/plugins/protocols.py:SinkProtocol.write:rows (list)"

  # Base classes - row data in plugin implementations
  - "src/elspeth/plugins/base.py:BaseTransform.process:row"
  - "src/elspeth/plugins/base.py:BaseGate.evaluate:row"
  - "src/elspeth/plugins/base.py:BaseSink.write:rows (list)"

  # Plugin utilities
  - "src/elspeth/plugins/utils.py:get_nested_field:data"

  # Sink plugins - row output (batch writes)
  - "src/elspeth/plugins/sinks/database_sink.py:DatabaseSink._ensure_table:row"
  - "src/elspeth/plugins/sinks/database_sink.py:DatabaseSink._create_columns_from_schema_or_row:row"
  - "src/elspeth/plugins/sinks/database_sink.py:DatabaseSink.write:rows (list)"
  - "src/elspeth/plugins/sinks/csv_sink.py:CSVSink.write:rows (list)"
  - "src/elspeth/plugins/sinks/csv_sink.py:CSVSink._open_file:rows (list)"
  - "src/elspeth/plugins/sinks/csv_sink.py:CSVSink._get_fieldnames_from_schema_or_row:row"
  - "src/elspeth/plugins/sinks/json_sink.py:JSONSink.write:rows (list)"
  - "src/elspeth/plugins/sinks/json_sink.py:JSONSink._write_jsonl_batch:rows (list)"

  # Transform plugins - row processing
  - "src/elspeth/plugins/transforms/passthrough.py:PassThrough.process:row"
  - "src/elspeth/plugins/transforms/field_mapper.py:FieldMapper.process:row"
  - "src/elspeth/plugins/transforms/batch_replicate.py:BatchReplicate.process:rows (list)"
  - "src/elspeth/plugins/transforms/batch_stats.py:BatchStats.process:rows (list)"
  - "src/elspeth/plugins/transforms/keyword_filter.py:KeywordFilter.process:row"
  - "src/elspeth/plugins/transforms/keyword_filter.py:KeywordFilter._get_fields_to_scan:row"
  - "src/elspeth/plugins/transforms/truncate.py:Truncate.process:row"
  - "src/elspeth/plugins/transforms/json_explode.py:JSONExplode.process:row"

  # Source plugins - row validation
  - "src/elspeth/plugins/sources/json_source.py:JSONSource._validate_and_yield:row"

  # Pooling executor - row processing
  - "src/elspeth/plugins/pooling/executor.py:PooledExecutor.get_stats:return"
  - "src/elspeth/plugins/pooling/executor.py:PooledExecutor._execute_single:row"

  # ═══════════════════════════════════════════════════════════════════════════
  # PLUGIN CONFIG (TRUST BOUNDARY)
  # Plugin config comes from external YAML and is validated internally by
  # Pydantic schemas before use. The dict[str, Any] is the input type before
  # validation - our code validates it into typed Pydantic models.
  # ═══════════════════════════════════════════════════════════════════════════

  # Protocols - config input
  - "src/elspeth/plugins/protocols.py:SourceProtocol.__init__:config"
  - "src/elspeth/plugins/protocols.py:TransformProtocol.__init__:config"
  - "src/elspeth/plugins/protocols.py:GateProtocol.__init__:config"
  - "src/elspeth/plugins/protocols.py:CoalesceProtocol.__init__:config"
  - "src/elspeth/plugins/protocols.py:SinkProtocol.__init__:config"

  # Base classes - config input
  - "src/elspeth/plugins/base.py:BaseTransform.__init__:config"
  - "src/elspeth/plugins/base.py:BaseGate.__init__:config"
  - "src/elspeth/plugins/base.py:BaseSink.__init__:config"
  - "src/elspeth/plugins/base.py:BaseSource.__init__:config"
  - "src/elspeth/plugins/config_base.py:PluginConfig.from_dict:config"

  # Plugin implementations - config input
  - "src/elspeth/plugins/sinks/database_sink.py:DatabaseSink.__init__:config"
  - "src/elspeth/plugins/sinks/csv_sink.py:CSVSink.__init__:config"
  - "src/elspeth/plugins/sinks/json_sink.py:JSONSink.__init__:config"
  - "src/elspeth/plugins/transforms/passthrough.py:PassThrough.__init__:config"
  - "src/elspeth/plugins/transforms/field_mapper.py:FieldMapper.__init__:config"
  - "src/elspeth/plugins/transforms/batch_replicate.py:BatchReplicate.__init__:config"
  - "src/elspeth/plugins/transforms/batch_stats.py:BatchStats.__init__:config"
  - "src/elspeth/plugins/transforms/keyword_filter.py:KeywordFilter.__init__:config"
  - "src/elspeth/plugins/transforms/truncate.py:Truncate.__init__:config"
  - "src/elspeth/plugins/transforms/json_explode.py:JSONExplode.__init__:config"
  - "src/elspeth/plugins/sources/json_source.py:JSONSource.__init__:config"
  - "src/elspeth/plugins/sources/csv_source.py:CSVSource.__init__:config"
  - "src/elspeth/plugins/sources/null_source.py:NullSource.__init__:config"

  # Plugin manager - factory methods for creating plugins from config
  - "src/elspeth/plugins/manager.py:PluginManager.create_source:config"
  - "src/elspeth/plugins/manager.py:PluginManager.create_transform:config"
  - "src/elspeth/plugins/manager.py:PluginManager.create_gate:config"
  - "src/elspeth/plugins/manager.py:PluginManager.create_sink:config"

  # Plugin validation - config validation before plugin instantiation
  - "src/elspeth/plugins/validation.py:PluginConfigValidator.validate_source_config:config"
  - "src/elspeth/plugins/validation.py:PluginConfigValidator.validate_transform_config:config"
  - "src/elspeth/plugins/validation.py:PluginConfigValidator.validate_gate_config:config"
  - "src/elspeth/plugins/validation.py:PluginConfigValidator.validate_sink_config:config"
  - "src/elspeth/plugins/validation.py:PluginConfigValidator.validate_schema_config:schema_config"

  # CLI - plugin instantiation from configuration
  - "src/elspeth/cli_helpers.py:instantiate_plugins_from_config:return"
  - "src/elspeth/cli.py:_execute_pipeline_with_instances:plugins"
  - "src/elspeth/cli.py:_execute_resume_with_instances:plugins"

  # DAG and config - runtime configuration dicts
  - "src/elspeth/core/dag.py:ExecutionGraph.add_node:config"
  - "src/elspeth/core/dag.py:ExecutionGraph.node_id:config"
  - "src/elspeth/core/config.py:resolve_config:return"
  - "src/elspeth/core/config.py:_expand_env_vars:config"
  - "src/elspeth/core/config.py:_expand_env_vars:return"
  - "src/elspeth/core/config.py:_fingerprint_secrets:options"
  - "src/elspeth/core/config.py:_fingerprint_secrets:return"
  - "src/elspeth/core/config.py:_expand_config_templates:raw_config"
  - "src/elspeth/core/config.py:_expand_config_templates:return"
  - "src/elspeth/core/config.py:_fingerprint_config_for_audit:config_dict"
  - "src/elspeth/core/config.py:_fingerprint_config_for_audit:return"
  - "src/elspeth/core/config.py:_expand_template_files:options"
  - "src/elspeth/core/config.py:_expand_template_files:return"
  - "src/elspeth/core/config.py:_recurse:d"
  - "src/elspeth/core/config.py:_recurse:return"

  # Canonical representation - deterministic JSON for hashing
  - "src/elspeth/core/canonical.py:_edge_to_canonical_dict:return"

  # Schema reconstruction - deserializing schemas from landscape database
  - "src/elspeth/engine/orchestrator.py:Orchestrator._reconstruct_schema_from_json:schema_dict"
  - "src/elspeth/engine/orchestrator.py:Orchestrator._json_schema_to_python_type:field_info"

  # ═══════════════════════════════════════════════════════════════════════════
  # AGGREGATION STATE
  # Aggregation plugins maintain arbitrary state between rows. The state format
  # is plugin-specific and cannot be typed at the framework level.
  # ═══════════════════════════════════════════════════════════════════════════
  - "src/elspeth/core/checkpoint/manager.py:CheckpointManager.create_checkpoint:aggregation_state"

  # ═══════════════════════════════════════════════════════════════════════════
  # PLUGIN CONTEXT - Recording and routing
  # PluginContext methods handle dynamic data from pipeline execution
  # ═══════════════════════════════════════════════════════════════════════════
  - "src/elspeth/plugins/context.py:PluginContext.get_checkpoint:return"
  - "src/elspeth/plugins/context.py:PluginContext.update_checkpoint:data"
  - "src/elspeth/plugins/context.py:PluginContext.record_call:request_data"
  - "src/elspeth/plugins/context.py:PluginContext.record_call:response_data"
  - "src/elspeth/plugins/context.py:PluginContext.record_call:error"
  - "src/elspeth/plugins/context.py:PluginContext.record_transform_error:row"
  - "src/elspeth/plugins/context.py:PluginContext.record_transform_error:error_details"
  - "src/elspeth/plugins/context.py:PluginContext.route_to_sink:row"
  - "src/elspeth/plugins/context.py:PluginContext.route_to_sink:metadata"

  # ═══════════════════════════════════════════════════════════════════════════
  # LANDSCAPE RECORDER - Audit trail recording
  # These methods handle dynamic data from pipeline execution
  # ═══════════════════════════════════════════════════════════════════════════
  - "src/elspeth/core/landscape/recorder.py:LandscapeRecorder.begin_run:config"
  - "src/elspeth/core/landscape/recorder.py:LandscapeRecorder.register_node:config"
  - "src/elspeth/core/landscape/recorder.py:LandscapeRecorder.create_row:data"
  - "src/elspeth/core/landscape/recorder.py:LandscapeRecorder.begin_node_state:input_data"
  - "src/elspeth/core/landscape/recorder.py:LandscapeRecorder.begin_node_state:context_before"
  - "src/elspeth/core/landscape/recorder.py:LandscapeRecorder.complete_node_state:output_data"
  - "src/elspeth/core/landscape/recorder.py:LandscapeRecorder.complete_node_state:error"
  - "src/elspeth/core/landscape/recorder.py:LandscapeRecorder.complete_node_state:context_after"
  - "src/elspeth/core/landscape/recorder.py:LandscapeRecorder.record_routing_event:reason"
  - "src/elspeth/core/landscape/recorder.py:LandscapeRecorder.record_routing_events:reason"
  - "src/elspeth/core/landscape/recorder.py:LandscapeRecorder.record_call:request_data"
  - "src/elspeth/core/landscape/recorder.py:LandscapeRecorder.record_call:response_data"
  - "src/elspeth/core/landscape/recorder.py:LandscapeRecorder.record_call:error"
  - "src/elspeth/core/landscape/recorder.py:LandscapeRecorder.record_token_outcome:context"
  - "src/elspeth/core/landscape/recorder.py:LandscapeRecorder.record_transform_error:row_data"
  - "src/elspeth/core/landscape/recorder.py:LandscapeRecorder.record_transform_error:error_details"
  - "src/elspeth/core/landscape/recorder.py:LandscapeRecorder.get_call_response_data:return"

  # ═══════════════════════════════════════════════════════════════════════════
  # FORMATTERS - Record formatting for export
  # Formatters work with audit records that have dynamic structure
  # ═══════════════════════════════════════════════════════════════════════════
  - "src/elspeth/core/landscape/formatters.py:ExportFormatter.format:record"
  - "src/elspeth/core/landscape/formatters.py:ExportFormatter.format:return"
  - "src/elspeth/core/landscape/formatters.py:JSONFormatter.format:record"
  - "src/elspeth/core/landscape/formatters.py:CSVFormatter.flatten:record"
  - "src/elspeth/core/landscape/formatters.py:CSVFormatter.flatten:return"
  - "src/elspeth/core/landscape/formatters.py:CSVFormatter.format:record"
  - "src/elspeth/core/landscape/formatters.py:CSVFormatter.format:return"

  # ═══════════════════════════════════════════════════════════════════════════
  # EXPORTER - Record signing
  # Exporter works with dynamic audit records
  # ═══════════════════════════════════════════════════════════════════════════
  - "src/elspeth/core/landscape/exporter.py:LandscapeExporter._sign_record:record"

  # ═══════════════════════════════════════════════════════════════════════════
  # LLM PLUGINS - External API trust boundary
  # LLM transforms handle dynamic row data and external API responses
  # ═══════════════════════════════════════════════════════════════════════════

  # LLM templates
  - "src/elspeth/plugins/llm/templates.py:PromptTemplate.__init__:lookup_data"
  - "src/elspeth/plugins/llm/templates.py:PromptTemplate.render:row"
  - "src/elspeth/plugins/llm/templates.py:PromptTemplate.render_with_metadata:row"

  # LLM base
  - "src/elspeth/plugins/llm/base.py:BaseLLMTransform.__init__:config"
  - "src/elspeth/plugins/llm/base.py:BaseLLMTransform.process:row"

  # LLM multi-query
  - "src/elspeth/plugins/llm/multi_query.py:QuerySpec.build_template_context:row"
  - "src/elspeth/plugins/llm/multi_query.py:QuerySpec.build_template_context:return"
  - "src/elspeth/plugins/llm/multi_query.py:CaseStudyConfig.to_template_data:return"
  - "src/elspeth/plugins/llm/multi_query.py:CriterionConfig.to_template_data:return"

  # LLM batch errors
  - "src/elspeth/plugins/llm/batch_errors.py:BatchPendingError.__init__:checkpoint"

  # Azure LLM
  - "src/elspeth/plugins/llm/azure.py:AzureLLMTransform.__init__:config"
  - "src/elspeth/plugins/llm/azure.py:AzureLLMTransform.process:row"
  - "src/elspeth/plugins/llm/azure.py:AzureLLMTransform._process_single_with_state:row"
  - "src/elspeth/plugins/llm/azure.py:AzureLLMTransform._process_batch:rows (list)"
  - "src/elspeth/plugins/llm/azure.py:AzureLLMTransform._process_batch_sequential:rows (list)"
  - "src/elspeth/plugins/llm/azure.py:AzureLLMTransform._process_sequential:row"
  - "src/elspeth/plugins/llm/azure.py:AzureLLMTransform._assemble_batch_results:rows (list)"
  - "src/elspeth/plugins/llm/azure.py:AzureLLMTransform.azure_config:return"

  # Azure batch LLM
  - "src/elspeth/plugins/llm/azure_batch.py:AzureBatchLLMTransform.__init__:config"
  - "src/elspeth/plugins/llm/azure_batch.py:AzureBatchLLMTransform.process:row"
  - "src/elspeth/plugins/llm/azure_batch.py:AzureBatchLLMTransform._process_single:row"
  - "src/elspeth/plugins/llm/azure_batch.py:AzureBatchLLMTransform._process_batch:rows (list)"
  - "src/elspeth/plugins/llm/azure_batch.py:AzureBatchLLMTransform._get_checkpoint:return"
  - "src/elspeth/plugins/llm/azure_batch.py:AzureBatchLLMTransform._update_checkpoint:data"
  - "src/elspeth/plugins/llm/azure_batch.py:AzureBatchLLMTransform._submit_batch:rows (list)"
  - "src/elspeth/plugins/llm/azure_batch.py:AzureBatchLLMTransform._check_batch_status:checkpoint"
  - "src/elspeth/plugins/llm/azure_batch.py:AzureBatchLLMTransform._check_batch_status:rows (list)"
  - "src/elspeth/plugins/llm/azure_batch.py:AzureBatchLLMTransform._download_results:checkpoint"
  - "src/elspeth/plugins/llm/azure_batch.py:AzureBatchLLMTransform._download_results:rows (list)"
  - "src/elspeth/plugins/llm/azure_batch.py:AzureBatchLLMTransform.azure_config:return"

  # Azure multi-query LLM
  - "src/elspeth/plugins/llm/azure_multi_query.py:AzureMultiQueryLLMTransform.__init__:config"
  - "src/elspeth/plugins/llm/azure_multi_query.py:AzureMultiQueryLLMTransform._process_single_query:row"
  - "src/elspeth/plugins/llm/azure_multi_query.py:AzureMultiQueryLLMTransform.process:row"
  - "src/elspeth/plugins/llm/azure_multi_query.py:AzureMultiQueryLLMTransform._process_single_row_internal:row"
  - "src/elspeth/plugins/llm/azure_multi_query.py:AzureMultiQueryLLMTransform._process_single_row:row"
  - "src/elspeth/plugins/llm/azure_multi_query.py:AzureMultiQueryLLMTransform._execute_queries_parallel:row"
  - "src/elspeth/plugins/llm/azure_multi_query.py:AzureMultiQueryLLMTransform._execute_queries_sequential:row"
  - "src/elspeth/plugins/llm/azure_multi_query.py:AzureMultiQueryLLMTransform._process_batch:rows (list)"

  # OpenRouter LLM
  - "src/elspeth/plugins/llm/openrouter.py:OpenRouterLLMTransform.__init__:config"
  - "src/elspeth/plugins/llm/openrouter.py:OpenRouterLLMTransform._process_batch:rows (list)"
  - "src/elspeth/plugins/llm/openrouter.py:OpenRouterLLMTransform._process_batch_sequential:rows (list)"
  - "src/elspeth/plugins/llm/openrouter.py:OpenRouterLLMTransform._process_sequential:row"
  - "src/elspeth/plugins/llm/openrouter.py:OpenRouterLLMTransform._assemble_batch_results:rows (list)"
  - "src/elspeth/plugins/llm/openrouter.py:OpenRouterLLMTransform.process:row"
  - "src/elspeth/plugins/llm/openrouter.py:OpenRouterLLMTransform._process_single_with_state:row"

  # ═══════════════════════════════════════════════════════════════════════════
  # AZURE PLUGINS - External cloud service trust boundary
  # ═══════════════════════════════════════════════════════════════════════════

  # Azure blob storage
  - "src/elspeth/plugins/azure/blob_source.py:AzureBlobSource.__init__:config"
  - "src/elspeth/plugins/azure/blob_sink.py:AzureBlobSink.__init__:config"
  - "src/elspeth/plugins/azure/blob_sink.py:AzureBlobSink._serialize_rows:rows (list)"
  - "src/elspeth/plugins/azure/blob_sink.py:AzureBlobSink._serialize_csv:rows (list)"
  - "src/elspeth/plugins/azure/blob_sink.py:AzureBlobSink._serialize_json:rows (list)"
  - "src/elspeth/plugins/azure/blob_sink.py:AzureBlobSink._serialize_jsonl:rows (list)"
  - "src/elspeth/plugins/azure/blob_sink.py:AzureBlobSink.write:rows (list)"

  # Azure content safety
  - "src/elspeth/plugins/transforms/azure/content_safety.py:AzureContentSafety.__init__:config"
  - "src/elspeth/plugins/transforms/azure/content_safety.py:AzureContentSafety.process:row"
  - "src/elspeth/plugins/transforms/azure/content_safety.py:AzureContentSafety._process_single:row"
  - "src/elspeth/plugins/transforms/azure/content_safety.py:AzureContentSafety._process_batch:rows (list)"
  - "src/elspeth/plugins/transforms/azure/content_safety.py:AzureContentSafety._process_batch_sequential:rows (list)"
  - "src/elspeth/plugins/transforms/azure/content_safety.py:AzureContentSafety._process_single_with_state:row"
  - "src/elspeth/plugins/transforms/azure/content_safety.py:AzureContentSafety._assemble_batch_results:rows (list)"
  - "src/elspeth/plugins/transforms/azure/content_safety.py:AzureContentSafety._get_fields_to_scan:row"

  # Azure prompt shield
  - "src/elspeth/plugins/transforms/azure/prompt_shield.py:AzurePromptShield.__init__:config"
  - "src/elspeth/plugins/transforms/azure/prompt_shield.py:AzurePromptShield.process:row"
  - "src/elspeth/plugins/transforms/azure/prompt_shield.py:AzurePromptShield._process_single:row"
  - "src/elspeth/plugins/transforms/azure/prompt_shield.py:AzurePromptShield._process_batch:rows (list)"
  - "src/elspeth/plugins/transforms/azure/prompt_shield.py:AzurePromptShield._process_batch_sequential:rows (list)"
  - "src/elspeth/plugins/transforms/azure/prompt_shield.py:AzurePromptShield._process_single_with_state:row"
  - "src/elspeth/plugins/transforms/azure/prompt_shield.py:AzurePromptShield._assemble_batch_results:rows (list)"
  - "src/elspeth/plugins/transforms/azure/prompt_shield.py:AzurePromptShield._get_fields_to_scan:row"

  # ═══════════════════════════════════════════════════════════════════════════
  # HTTP CLIENTS - External API trust boundary
  # ═══════════════════════════════════════════════════════════════════════════
  - "src/elspeth/plugins/clients/http.py:AuditedHTTPClient.post:json"
  - "src/elspeth/plugins/clients/replayer.py:ReplayMissError.__init__:request_data"
  - "src/elspeth/plugins/clients/replayer.py:CallReplayer.replay:request_data"
  - "src/elspeth/plugins/clients/verifier.py:CallVerifier.verify:request_data"
  - "src/elspeth/plugins/clients/verifier.py:CallVerifier.verify:live_response"

  # ═══════════════════════════════════════════════════════════════════════════
  # TUI - Display of dynamic audit data
  # ═══════════════════════════════════════════════════════════════════════════
  - "src/elspeth/tui/widgets/lineage_tree.py:LineageTree.get_tree_nodes:return (list)"
  - "src/elspeth/tui/widgets/lineage_tree.py:LineageTree._flatten_tree:result (list)"
