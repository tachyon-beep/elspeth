============================= test session starts ==============================
platform linux -- Python 3.12.3, pytest-8.4.2, pluggy-1.6.0 -- /home/john/elspeth/.venv/bin/python
cachedir: .pytest_cache
rootdir: /home/john/elspeth
configfile: pyproject.toml
plugins: cov-7.0.0, asyncio-1.2.0, mock-3.15.1, anyio-4.11.0
asyncio: mode=Mode.STRICT, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collecting ... collected 9 items

tests/test_runner_characterization.py::test_run_result_structure PASSED  [ 11%]
tests/test_runner_characterization.py::test_run_preserves_dataframe_order PASSED [ 22%]
tests/test_runner_characterization.py::test_run_checkpoint_idempotency PASSED [ 33%]
tests/test_runner_characterization.py::test_run_early_stop_terminates_processing PASSED [ 44%]
tests/test_runner_characterization.py::test_run_aggregator_receives_complete_results PASSED [ 55%]
tests/test_runner_characterization.py::test_run_single_failure_doesnt_block_others PASSED [ 66%]
tests/test_runner_safety.py::test_run_with_empty_dataframe PASSED        [ 77%]
tests/test_runner_safety.py::test_run_with_concurrent_execution PASSED   [ 88%]
tests/test_runner_safety.py::test_run_with_failing_aggregator PASSED     [100%]

================================ tests coverage ================================
_______________ coverage: platform linux, python 3.12.3-final-0 ________________

Name                                                                          Stmts   Miss Branch BrPart  Cover   Missing
-------------------------------------------------------------------------------------------------------------------------
src/elspeth/adapters/__init__.py                                                  2      0      0      0   100%
src/elspeth/adapters/blob_store.py                                              135    100     32      0    21%   47-84, 98-114, 124-160, 174-177, 183-204, 209-223, 228-231, 236-238, 243-247, 260-263
src/elspeth/cli.py                                                              264    264     64      0     0%   8-558
src/elspeth/config.py                                                           256    256     82      0     0%   3-477
src/elspeth/core/__init__.py                                                      3      0      0      0   100%
src/elspeth/core/base/__init__.py                                                 2      0      0      0   100%
src/elspeth/core/base/plugin_context.py                                          52     23      4      0    52%   53-55, 61, 67, 89-97, 119-133
src/elspeth/core/base/protocols.py                                               78     12      0      0    85%   53, 67, 87, 118, 129, 149, 168, 183, 195-196, 214, 218
src/elspeth/core/base/schema/__init__.py                                          6      0      0      0   100%
src/elspeth/core/base/schema/base.py                                             23     11      0      0    52%   32-34, 78-82, 86, 96-97
src/elspeth/core/base/schema/inference.py                                        32     23     14      0    20%   31-45, 65-83
src/elspeth/core/base/schema/model_factory.py                                    47     40     28      0     9%   29-47, 67-125
src/elspeth/core/base/schema/validation.py                                       66     54     36      0    12%   31-33, 70-81, 97-140, 149-156, 168-177, 182-184
src/elspeth/core/base/types.py                                                  107     42     16      0    53%   32-41, 45, 49-51, 55, 83-91, 95, 99-101, 105, 190-215, 223-250, 316-340
src/elspeth/core/cli/__init__.py                                                  7      7      0      0     0%   8-26
src/elspeth/core/cli/common.py                                                   81     81     10      0     0%   11-164
src/elspeth/core/cli/config_utils.py                                             58     58     38      0     0%   3-83
src/elspeth/core/cli/job.py                                                      46     46     18      0     0%   3-73
src/elspeth/core/cli/single.py                                                   55     55     16      0     0%   3-108
src/elspeth/core/cli/suite.py                                                   122    122     52      0     0%   3-248
src/elspeth/core/cli/validate.py                                                 78     78     22      0     0%   3-136
src/elspeth/core/config/__init__.py                                               3      0      0      0   100%
src/elspeth/core/config/schema.py                                                10      4      2      0    50%   50-53
src/elspeth/core/config/validation.py                                           110    100     62      0     6%   53-98, 120-139, 155-199, 215-239
src/elspeth/core/controls/__init__.py                                             4      0      0      0   100%
src/elspeth/core/controls/cost_tracker.py                                        42     30     12      0    22%   14, 19, 40-44, 49-59, 68, 78-91
src/elspeth/core/controls/cost_tracker_registry.py                               19      6      4      0    57%   26, 31-36
src/elspeth/core/controls/rate_limit.py                                         138    116     46      0    12%   15-22, 31-32, 68-75, 80-97, 101-107, 120-130, 134-161, 165-181, 185-193, 196-200, 203-208
src/elspeth/core/controls/rate_limiter_registry.py                               31     15      8      0    41%   31, 36-41, 49-58
src/elspeth/core/controls/registry.py                                            77     58     20      0    20%   35-45, 55-65, 80-82, 104-106, 122-152, 161-191
src/elspeth/core/experiments/__init__.py                                          5      0      0      0   100%
src/elspeth/core/experiments/config.py                                          115     53     20      0    46%   89-91, 97-99, 112-174, 183-198, 210-216, 226, 261-278
src/elspeth/core/experiments/config_merger.py                                    78     67     48      0     9%   52-54, 84-115, 139-161, 192-212, 242-261
src/elspeth/core/experiments/experiment_registries.py                            19      0      0      0   100%
src/elspeth/core/experiments/job_runner.py                                      132    132     42      0     0%   36-261
src/elspeth/core/experiments/plugin_registry.py                                 184    147     58      0    15%   125-144, 157-168, 181-192, 205-216, 229-240, 251-278, 286-312, 320-346, 354-380, 388-414, 422-427, 432-436, 441-455, 465-466
src/elspeth/core/experiments/runner.py                                          447    104    172     39    71%   100-105, 117, 129, 138->140, 148, 185->183, 187->189, 205->203, 211->209, 221-224, 255-257, 263-264, 279, 282->285, 287, 301->304, 317, 331, 354, 366->372, 395, 418-433, 439->437, 456->exit, 462->exit, 468-470, 474, 479-483, 497-533, 543->545, 577->656, 588, 591, 596-597, 610, 612-614, 634, 648-654, 657, 658->666, 684-687, 701-704, 712, 733, 742-761
src/elspeth/core/experiments/suite_runner.py                                    189    161     76      0    11%   63-233, 241-248, 251-279, 299-419
src/elspeth/core/experiments/tools.py                                            56     41     18      0    20%   22-39, 50-83, 89-91, 100-104, 108-114
src/elspeth/core/experiments/validation.py                                       26     21     18      0    11%   24-59
src/elspeth/core/healthcheck.py                                                  57     57      6      0     0%   24-148
src/elspeth/core/orchestrator.py                                                 74     74      6      0     0%   3-180
src/elspeth/core/pipeline/__init__.py                                             4      0      0      0   100%
src/elspeth/core/pipeline/artifact_pipeline.py                                  244    118    104     18    44%   35-48, 54-55, 87-100, 105, 110, 117-139, 162, 169-182, 185->197, 188-195, 199->203, 202, 210-213, 228, 241-244, 257-278, 293-297, 323-330, 365->374, 367-369, 375->378, 382->387, 385, 388-393, 396->360, 398-406
src/elspeth/core/pipeline/artifacts.py                                           19      9      4      0    43%   15, 21, 27-32, 38
src/elspeth/core/pipeline/processing.py                                          12      4      8      2    50%   32, 35-37
src/elspeth/core/prompts/__init__.py                                              4      0      0      0   100%
src/elspeth/core/prompts/engine.py                                               52     13     10      1    68%   25, 54-56, 81-84, 102-107
src/elspeth/core/prompts/exceptions.py                                           11      5      0      0    55%   14-16, 23-24
src/elspeth/core/prompts/loader.py                                               14     14      0      0     0%   3-38
src/elspeth/core/prompts/template.py                                             25      3      6      3    81%   29, 30->32, 33, 51
src/elspeth/core/registries/__init__.py                                          10      2      0      0    80%   77-79
src/elspeth/core/registries/base.py                                             108     59     22      2    41%   76-102, 130-141, 220->229, 223-228, 243-251, 256-259, 311, 324-327, 348-349, 358, 378, 391, 430-442
src/elspeth/core/registries/context_utils.py                                     56     19     26     11    59%   82, 84, 86, 88, 97, 103, 112-115, 120->128, 122, 170, 184, 225-230
src/elspeth/core/registries/datasource.py                                        47     47      4      0     0%   8-196
src/elspeth/core/registries/llm.py                                               86     60     22      0    24%   46-88, 104-121, 127-143, 148, 153-158
src/elspeth/core/registries/middleware.py                                        46     31     10      0    27%   41-56, 68-70, 75-109
src/elspeth/core/registries/plugin_helpers.py                                    67     57     26      0    11%   95-211
src/elspeth/core/registries/schemas.py                                           30      6      6      1    69%   99-104
src/elspeth/core/registries/sink.py                                             125     50      6      0    57%   70-101, 106, 112-131, 136, 141, 146, 151, 156, 161, 166, 171, 176, 181, 197, 212, 242
src/elspeth/core/registries/utility.py                                           16     16      0      0     0%   3-71
src/elspeth/core/security/__init__.py                                           112     71     64     10    34%   38, 50, 52, 56, 64-88, 93-105, 116, 122-124, 134-140, 143, 153-159, 164-167, 182-188, 191, 197-215
src/elspeth/core/security/approved_endpoints.py                                  93     72     36      0    16%   114-136, 149-153, 169-187, 213-280, 297-299, 315, 336, 357, 370
src/elspeth/core/security/keyvault.py                                            39     25     10      0    29%   30-42, 58-74
src/elspeth/core/security/pii_validators.py                                      60     52     22      0    10%   34-46, 64-78, 97-108, 126-144, 157-174, 190-192, 204
src/elspeth/core/security/secure_mode.py                                         94     70     44      0    17%   30, 39-53, 75-85, 94, 103, 112, 126-130, 149-168, 181-194, 207-234, 247-255, 267-289
src/elspeth/core/security/signing.py                                             79     59     24      0    19%   40-42, 48-53, 57, 61-62, 66-81, 85-90, 98-104, 113-132, 141-163
src/elspeth/core/utils/__init__.py                                                3      0      0      0   100%
src/elspeth/core/utils/env_helpers.py                                            17     11      6      0    26%   29-33, 62-67
src/elspeth/core/utils/logging.py                                               209    180     72      0    10%   64-105, 109-170, 175-184, 188-194, 199-213, 217-220, 224-253, 279-306, 330-344, 370-386, 408-420, 438-447, 460-480, 495-504
src/elspeth/core/utils/path_guard.py                                             66     53     16      0    16%   25-38, 47-54, 63-64, 69-71, 81-122
src/elspeth/core/validation/__init__.py                                          12      8      4      0    25%   27-36
src/elspeth/core/validation/base.py                                             126     96     66      0    16%   23-25, 38, 43, 48-49, 54-56, 61, 66, 77-88, 101-119, 130-135, 146-154, 165-170, 181-183, 194-211, 217-229, 235, 239-247
src/elspeth/core/validation/rules.py                                            119    119     58      0     0%   3-214
src/elspeth/core/validation/schemas.py                                            7      7      0      0     0%   3-88
src/elspeth/core/validation/settings.py                                         148    148     56      0     0%   3-377
src/elspeth/core/validation/suite.py                                            140    140     44      0     0%   3-284
src/elspeth/core/validation/validators.py                                         5      5      0      0     0%   3-15
src/elspeth/plugins/experiments/__init__.py                                       5      0      0      0   100%
src/elspeth/plugins/experiments/_stats_helpers.py                               312    294    128      0     4%   20-33, 46-62, 70-92, 102-120, 141-193, 224-263, 289-342, 366-377, 398-450, 458-501, 519-543
src/elspeth/plugins/experiments/aggregators/__init__.py                           2      0      0      0   100%
src/elspeth/plugins/experiments/aggregators/cost_summary.py                      85     62     30      0    20%   39-41, 44-45, 53-116, 120, 133-135, 138-139, 147-172, 189
src/elspeth/plugins/experiments/aggregators/latency_summary.py                   40     23     12      0    33%   39-41, 44-45, 53-78, 95
src/elspeth/plugins/experiments/aggregators/rationale_analysis.py               130    108     46      0    12%   57-67, 112-113, 121-236, 244-262, 266-269, 273-291, 299
src/elspeth/plugins/experiments/aggregators/score_agreement.py                   84     66     34      0    15%   38-42, 45-46, 54-122, 131
src/elspeth/plugins/experiments/aggregators/score_power.py                       59     41     16      0    24%   54-62, 65-66, 74-129, 133
src/elspeth/plugins/experiments/aggregators/score_recommendation.py              59     42     18      0    22%   44-46, 49-71, 74-83, 86-98, 102
src/elspeth/plugins/experiments/aggregators/score_stats.py                       99     76     36      0    17%   44-46, 49-84, 90-113, 117, 126-127, 130-145, 149-158
src/elspeth/plugins/experiments/aggregators/score_variant_ranking.py             49     35     14      0    22%   25-27, 30-61, 74
src/elspeth/plugins/experiments/baseline/__init__.py                              2      0      0      0   100%
src/elspeth/plugins/experiments/baseline/category_effects.py                     89     68     30      0    18%   58-64, 67-68, 77-134, 143-149, 153-159, 163-186
src/elspeth/plugins/experiments/baseline/criteria_effects.py                     57     39     12      0    26%   57-62, 65-66, 74-129
src/elspeth/plugins/experiments/baseline/outlier_detection.py                    75     57     26      0    18%   53-58, 61-62, 70-130, 138-155
src/elspeth/plugins/experiments/baseline/referee_alignment.py                   131    110     62      0    11%   58-75, 78-79, 88-165, 169-200, 204-217, 222-237, 241-277
src/elspeth/plugins/experiments/baseline/score_assumptions.py                    60     44     16      0    21%   47-52, 55-56, 64-117
src/elspeth/plugins/experiments/baseline/score_bayesian.py                       39     24     10      0    31%   46-51, 54-55, 63-78
src/elspeth/plugins/experiments/baseline/score_cliffs_delta.py                   36     21      8      0    34%   38-42, 45-46, 54-73
src/elspeth/plugins/experiments/baseline/score_delta.py                          42     27     14      0    27%   34-35, 38-53, 57-66
src/elspeth/plugins/experiments/baseline/score_distribution.py                   39     23     10      0    33%   44-48, 52, 55-56, 64-78
src/elspeth/plugins/experiments/baseline/score_flip_analysis.py                  62     46     32      0    17%   54-60, 63-64, 73-145
src/elspeth/plugins/experiments/baseline/score_practical.py                      45     29     10      0    29%   49-55, 58-59, 67-98
src/elspeth/plugins/experiments/baseline/score_significance.py                   82     66     34      0    14%   52-62, 65-66, 74-130
src/elspeth/plugins/experiments/early_stop.py                                    66     53     26      0    14%   24-41, 44-45, 48-80, 84-90, 94-100
src/elspeth/plugins/experiments/prompt_variants.py                               72     57     18      0    17%   31-38, 41-145, 149-162
src/elspeth/plugins/experiments/row/__init__.py                                   2      0      0      0   100%
src/elspeth/plugins/experiments/row/score_extractor.py                           90     67     38      0    18%   75-81, 94-115, 118-131, 135-147, 154-164, 168, 173-174
src/elspeth/plugins/experiments/validation.py                                    99     69     32      0    23%   19-24, 33-35, 38-49, 58-60, 69, 78-84, 102-107, 116-136, 140-143, 177-199
src/elspeth/plugins/nodes/__init__.py                                             1      0      0      0   100%
src/elspeth/plugins/nodes/sinks/__init__.py                                      22      0      0      0   100%
src/elspeth/plugins/nodes/sinks/_sanitize.py                                     36     27     18      0    17%   13-16, 20-23, 29-37, 43-53
src/elspeth/plugins/nodes/sinks/_visual_base.py                                 108     74     26      0    25%   66-78, 92-97, 112-114, 130-137, 152-154, 167-172, 191-212, 226-228, 257-268, 284-291, 297, 301, 305, 309
src/elspeth/plugins/nodes/sinks/analytics_report.py                             114     99     52      0     9%   31-49, 52-85, 109-122, 125-160, 163-215
src/elspeth/plugins/nodes/sinks/blob.py                                         253    215    104      0    11%   55-78, 81-143, 147-154, 157-177, 180-193, 197, 206-217, 220-236, 239-241, 251-268, 276-281, 284-296, 312-319, 330-340, 344-349, 356-367, 388-390, 393-413, 416-425, 435-444
src/elspeth/plugins/nodes/sinks/csv_file.py                                      97     79     38      0    13%   47-69, 75-77, 80-82, 93-112, 123-135, 139-191
src/elspeth/plugins/nodes/sinks/embeddings_store.py                             250    198     82      0    16%   83-96, 99-103, 119-147, 150-151, 158-173, 194-207, 210-226, 252-277, 280-348, 356-369, 384, 388-397, 400-405, 408-418, 421-430, 433-476, 479-483, 486-504
src/elspeth/plugins/nodes/sinks/enhanced_visual_report.py                       258    232     96      0     7%   48-68, 72-138, 158-180, 187-230, 241-253, 259-288, 294-321, 327-377, 383-422, 428-455, 459-480, 484-485
src/elspeth/plugins/nodes/sinks/excel.py                                        174    134     60      0    17%   46, 76-119, 125-178, 182-184, 187-189, 192-197, 200-211, 220-228, 231-243, 247-259, 267-277
src/elspeth/plugins/nodes/sinks/file_copy.py                                     63     50     18      0    16%   26-39, 62-113
src/elspeth/plugins/nodes/sinks/local_bundle.py                                  98     69     32      0    22%   39-51, 56-128, 132-137, 140-155
src/elspeth/plugins/nodes/sinks/repository.py                                   310    231     84      0    20%   45-47, 51-56, 60, 92-125, 130, 133-134, 139, 142, 145-169, 177, 197-200, 214-215, 223-224, 232-233, 236-243, 246-250, 254-255, 267-282, 293, 317-318, 335-345, 358-367, 375-384, 387-396, 399-407, 426-437, 450-483, 487-497, 500-510, 513-520, 523-531, 534-536, 556-558, 561-599, 602-607, 610-633
src/elspeth/plugins/nodes/sinks/reproducibility_bundle.py                       373    285    128      0    18%   81-85, 89-171, 175-181, 185-196, 200-216, 222, 226-231, 234-240, 243-247, 250-259, 262-266, 270-286, 290-322, 326-346, 350-354, 358-365, 369-382, 387-409, 413-426, 432-436, 440-460, 469, 505-510, 520-526, 530-549, 554-558, 563, 568-573, 582-594, 600-601, 612, 616, 620-635, 639
src/elspeth/plugins/nodes/sinks/signed.py                                       125     91     46      0    20%   40-47, 50-121, 124-129, 138-154, 158-161, 164-182
src/elspeth/plugins/nodes/sinks/visual_report.py                                183    166     88      0     6%   36-50, 54-160, 188-211, 217-268, 271-279, 288-314
src/elspeth/plugins/nodes/sinks/zip_bundle.py                                   168    142     76      0    11%   44-76, 81-170, 173-175, 178-180, 184-187, 195-207, 210-234, 278-288
src/elspeth/plugins/nodes/transforms/__init__.py                                  1      0      0      0   100%
src/elspeth/plugins/nodes/transforms/llm/__init__.py                              7      0      0      0   100%
src/elspeth/plugins/nodes/transforms/llm/azure_openai.py                         63     50     20      0    16%   21-30, 33-42, 49-62, 69-72, 75-81, 85, 94-113
src/elspeth/plugins/nodes/transforms/llm/middleware/__init__.py                   8      0      0      0   100%
src/elspeth/plugins/nodes/transforms/llm/middleware/audit.py                     25     11      4      0    48%   34-35, 38-42, 45-48
src/elspeth/plugins/nodes/transforms/llm/middleware/azure_content_safety.py      71     52     18      0    21%   58-82, 85-99, 102-141
src/elspeth/plugins/nodes/transforms/llm/middleware/classified_material.py      140    116     76      0    11%   220-255, 264-276, 284-327, 335-352, 360-377, 381-453
src/elspeth/plugins/nodes/transforms/llm/middleware/health_monitor.py            55     37     12      0    27%   41-52, 55-58, 61-71, 74-93
src/elspeth/plugins/nodes/transforms/llm/middleware/pii_shield.py               183    156     88      0    10%   301-339, 352-370, 378-391, 399-425, 434-442, 450-472, 476-636
src/elspeth/plugins/nodes/transforms/llm/middleware/prompt_shield.py             31     18     10      0    32%   38-44, 47-57
src/elspeth/plugins/nodes/transforms/llm/middleware_azure.py                    169    137     62      0    14%   52-56, 62-73, 91-131, 134-149, 152-173, 182-190, 193-198, 206-241, 244-248, 251-253, 256-266, 269-273, 284-288, 299-303, 314-316
src/elspeth/plugins/nodes/transforms/llm/mock.py                                 22     13      2      0    38%   15, 24-26, 40-48
src/elspeth/plugins/nodes/transforms/llm/openai_http.py                          41     27      8      0    29%   37-79, 88-115
src/elspeth/plugins/nodes/transforms/llm/static.py                               14      7      2      0    44%   20-22, 31-34
src/elspeth/plugins/orchestrators/__init__.py                                     1      0      0      0   100%
src/elspeth/plugins/orchestrators/experiment/__init__.py                          8      4      2      0    40%   15-19
src/elspeth/plugins/orchestrators/experiment/protocols.py                        20      0      0      0   100%
src/elspeth/retrieval/__init__.py                                                 3      0      0      0   100%
src/elspeth/retrieval/embedding.py                                               59     46     16      0    17%   37-58, 61-62, 77-113, 116-117
src/elspeth/retrieval/providers.py                                              130    103     42      0    16%   74-79, 88-103, 129-180, 184-185, 202-212, 223-241, 251-300
src/elspeth/retrieval/service.py                                                 61     51     18      0    13%   16-17, 27-28, 42-54, 58-109
-------------------------------------------------------------------------------------------------------------------------
TOTAL                                                                         11398   8554   3866     87    20%

1 empty file skipped.
============================== 9 passed in 4.68s ===============================
