# docker-compose.yaml - ELSPETH Container Orchestration
#
# This compose file supports CLI tool invocation patterns:
#   docker compose run --rm elspeth <command>
#
# Usage Examples:
#   # Run a pipeline
#   docker compose run --rm elspeth run --settings /app/config/pipeline.yaml --execute
#
#   # Validate configuration
#   docker compose run --rm elspeth validate --settings /app/config/pipeline.yaml
#
#   # Explain a row from a previous run
#   docker compose run --rm elspeth explain --run latest --row 42 --no-tui
#
#   # Check version
#   docker compose run --rm elspeth --version
#
#   # Run health check
#   docker compose run --rm elspeth health
#
#   # With PostgreSQL backend
#   docker compose --profile with-postgres up -d postgres
#   docker compose run --rm elspeth run --settings /app/config/pipeline.yaml --execute

services:
  elspeth:
    image: ${REGISTRY:-ghcr.io/your-org}/elspeth:${IMAGE_TAG:-latest}
    # No 'restart' policy - this is a CLI tool, not a daemon
    environment:
      # Database URL - defaults to SQLite in /app/state
      - DATABASE_URL=${DATABASE_URL:-sqlite:////app/state/landscape.db}
      # OpenTelemetry endpoint for distributed tracing (optional)
      - OTEL_EXPORTER_OTLP_ENDPOINT=${OTEL_ENDPOINT:-}
      - OTEL_SERVICE_NAME=elspeth
      # Log level
      - ELSPETH_LOG_LEVEL=${LOG_LEVEL:-INFO}
      # LLM API keys (passed through, never stored in image)
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - AZURE_OPENAI_API_KEY=${AZURE_OPENAI_API_KEY:-}
      - AZURE_OPENAI_ENDPOINT=${AZURE_OPENAI_ENDPOINT:-}
      - OPENROUTER_API_KEY=${OPENROUTER_API_KEY:-}
    working_dir: /app
    volumes:
      # Configuration files (read-only)
      - ./config:/app/config:ro
      # Source data files (read-only)
      - ./input:/app/input:ro
      # Sink output files (read-write)
      - ./output:/app/output
      # State: SQLite DB, checkpoints, payloads (read-write)
      - ./state:/app/state
      # Optional: secrets file (uncomment if needed)
      # - ./secrets:/app/secrets:ro
    # Default command shows help; override with 'docker compose run'
    command: ["--help"]

  # Optional: PostgreSQL for production landscape database
  postgres:
    image: postgres:16-alpine
    profiles: ["with-postgres"]
    environment:
      POSTGRES_DB: elspeth
      POSTGRES_USER: elspeth
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:?POSTGRES_PASSWORD required}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U elspeth"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Optional: Jaeger for OpenTelemetry trace visualization
  jaeger:
    image: jaegertracing/all-in-one:1.54
    profiles: ["with-tracing"]
    ports:
      - "16686:16686"  # Jaeger UI
      - "4317:4317"    # OTLP gRPC
      - "4318:4318"    # OTLP HTTP
    environment:
      - COLLECTOR_OTLP_ENABLED=true

volumes:
  postgres_data:
