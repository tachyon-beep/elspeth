# Bug Report: Token outcome group IDs do not match token lineage group IDs

## Summary

- RowProcessor generates new UUIDs for `fork_group_id`, `expand_group_id`, and `join_group_id` when recording token outcomes. These IDs do not match the group IDs generated by LandscapeRecorder when creating forked/expanded/coalesced tokens, so audit lineage cannot be correlated across tables.

## Severity

- Severity: major
- Priority: P1

## Reporter

- Name or handle: Codex
- Date: 2026-01-21
- Related run/issue ID: N/A

## Environment

- Commit/branch: ae2c0e6 / fix/rc1-bug-burndown-session-2
- OS: Linux
- Python version: Python 3.13.1
- Config profile / env vars: N/A
- Data set or fixture: N/A

## Agent Context (if relevant)

- Goal or task prompt: Deep dive src/elspeth/engine/processor.py for bugs; create reports.
- Model/version: GPT-5 (Codex CLI)
- Tooling and permissions (sandbox/approvals): workspace-write, no escalations
- Determinism details (seed, run ID): N/A
- Notable tool calls or steps: Code inspection only

## Steps To Reproduce

1. Run a pipeline that includes:
   - A gate fork (`fork_to_paths`)
   - A multi-row transform (`success_multi`) to trigger expansion
   - A coalesce merge
2. Inspect `tokens.*_group_id` and `token_outcomes.*_group_id` values.

## Expected Behavior

- `token_outcomes.fork_group_id` matches `tokens.fork_group_id` for forked tokens.
- `token_outcomes.expand_group_id` matches `tokens.expand_group_id` for expanded tokens.
- `token_outcomes.join_group_id` matches `tokens.join_group_id` for coalesced tokens.

## Actual Behavior

- Token outcomes use unrelated UUIDs, so group IDs cannot be correlated across audit tables.

## Evidence

- RowProcessor generates new IDs:
  - Fork: `src/elspeth/engine/processor.py:717-724`
  - Expand: `src/elspeth/engine/processor.py:851-858`
  - Coalesce: `src/elspeth/engine/processor.py:981-988`
- Recorder generates different group IDs when creating tokens:
  - `src/elspeth/core/landscape/recorder.py:820-872` (fork)
  - `src/elspeth/core/landscape/recorder.py:866-919` (coalesce)
  - `src/elspeth/core/landscape/recorder.py:934-982` (expand)

## Impact

- User-facing impact: Lineage reports cannot reliably connect token outcomes to fork/expand/coalesce groups.
- Data integrity / security impact: Audit trail violates traceability guarantees.
- Performance or cost impact: None directly.

## Root Cause Hypothesis

- Token group IDs are generated in the recorder but not propagated to RowProcessor, which generates its own IDs.

## Proposed Fix

- Code changes (modules/files): `src/elspeth/engine/processor.py`, `src/elspeth/engine/tokens.py` (expose group IDs), possibly `src/elspeth/core/landscape/recorder.py` to return IDs.
- Config or schema changes: None
- Tests to add/update: Add tests asserting outcome group IDs match token group IDs for fork/expand/coalesce.
- Risks or migration steps: None (fix is internal linkage).

## Architectural Deviations

- Spec or doc reference (e.g., docs/design/architecture.md#L...): `docs/design/subsystems/00-overview.md` (fork/join group IDs for tokens).
- Observed divergence: Outcome group IDs do not line up with token group IDs.
- Reason (if known): Group IDs not exposed to processor.
- Alignment plan or decision needed: Decide canonical source for group IDs and propagate consistently.

## Acceptance Criteria

- Group IDs recorded in `token_outcomes` match those stored on tokens.
- Tests validate linkage for fork/expand/coalesce.

## Tests

- Suggested tests to run: `pytest tests/engine/test_processor.py -k group_id`
- New tests required: Yes (group ID linkage).

## Notes / Links

- Related issues/PRs: N/A
- Related design docs: `docs/design/subsystems/00-overview.md`

## Verification (2026-01-25)

**Status: STILL VALID**

The bug still exists in the current codebase (commit 0efbda2 on fix/rc1-bug-burndown-session-4 branch).

### Evidence

**1. Recorder creates group IDs but doesn't return them to processor:**

In `/home/john/elspeth-rapid/src/elspeth/core/landscape/recorder.py`:
- `fork_token()` generates `fork_group_id` at line 850 and stores it in Token objects
- `expand_token()` generates `expand_group_id` at line 977 and stores it in Token objects
- `coalesce_tokens()` generates `join_group_id` at line 912 and stores it in Token object

The recorder methods return `Token` model objects that contain these group IDs (see `Token` model at `/home/john/elspeth-rapid/src/elspeth/core/landscape/models.py:93-103` with fields `fork_group_id`, `expand_group_id`, `join_group_id`).

**2. TokenManager loses group IDs when converting to TokenInfo:**

In `/home/john/elspeth-rapid/src/elspeth/engine/tokens.py`:
- `TokenManager.fork_token()` calls recorder and gets back Token objects with `fork_group_id` populated (line 150-155)
- But then creates `TokenInfo` objects WITHOUT the `fork_group_id` field (lines 160-168)
- Same pattern in `coalesce_tokens()` (lines 192-202) - loses `join_group_id`
- Same pattern in `expand_token()` (lines 246-255) - loses `expand_group_id`

The `TokenInfo` dataclass (at `/home/john/elspeth-rapid/src/elspeth/contracts/identity.py:11-26`) only has fields: `row_id`, `token_id`, `row_data`, `branch_name` - it does not include group ID fields.

**3. Processor generates NEW group IDs when recording outcomes:**

In `/home/john/elspeth-rapid/src/elspeth/engine/processor.py`:
- Line 708: `fork_group_id = uuid.uuid4().hex[:16]` (NEW ID for FORKED outcome)
- Line 842: `expand_group_id = uuid.uuid4().hex[:16]` (NEW ID for EXPANDED outcome)
- Line 929: `cfg_fork_group_id = uuid.uuid4().hex[:16]` (NEW ID for config-based fork)
- Line 972: `join_group_id = f"{coalesce_name}_{uuid.uuid4().hex[:8]}"` (NEW ID for COALESCED outcome)

These newly generated IDs are completely unrelated to the group IDs already stored in the tokens table.

### Root Cause

The architecture has a broken data flow:

```
Recorder.fork_token()
  → generates fork_group_id
  → stores in tokens table ✓
  → returns Token object with fork_group_id ✓
    ↓
TokenManager.fork_token()
  → receives Token objects with fork_group_id
  → DISCARDS group IDs when creating TokenInfo ✗
  → returns TokenInfo without group IDs
    ↓
RowProcessor._process_row()
  → receives TokenInfo without group IDs
  → GENERATES NEW group_id ✗
  → records outcome with WRONG group_id
```

The `TokenInfo` contract is missing the group ID fields that exist on the `Token` model, causing information loss at the TokenManager layer.

### Impact on Audit Trail

This breaks the ability to link token outcomes to token lineage groups:

- Query: "Show me all child tokens from fork group X"
  - Tokens table: has the correct `fork_group_id`
  - Token_outcomes table: has a DIFFERENT `fork_group_id`
  - Result: Cannot correlate the parent's FORKED outcome with the children's existence

- For explain() queries that need to trace "why did this token exist?":
  - Can find the parent token via `token_parents` table ✓
  - Can find the parent's FORKED outcome ✓
  - CANNOT link the parent's outcome to the specific fork group the child belongs to ✗

This violates ELSPETH's auditability standard: "Every decision must be traceable to source data." The fork/expand/coalesce decisions ARE traceable via token_parents, but the group membership recorded in outcomes is incorrect.

### Git History Check

No fixes found in git history since the bug was reported on 2026-01-21:
- No commits mention "group_id" in relation to outcomes
- Recent processor.py commits (0a9cf2a, c6afc31, e93e56c, 6befd9a) added outcome recording features but did not address group ID correctness
- The commit 0a9cf2a "fix(audit): record COMPLETED outcomes with sink_name" is about sink_name disambiguation, not group IDs

### Recommended Fix

1. Add group ID fields to `TokenInfo` contract (fork_group_id, expand_group_id, join_group_id)
2. Update `TokenManager` methods to preserve group IDs from Token objects when creating TokenInfo
3. Update `RowProcessor` to use the group IDs from TokenInfo instead of generating new ones
4. Add integration tests that verify `token_outcomes.*_group_id` matches `tokens.*_group_id` for the same token_id

---

## Closure (2026-01-27)

**Status: FIXED**

### Fix History

The original bug (group ID mismatch) was fixed in stages:

1. **TokenInfo contract** - Group ID fields added (commit unknown, prior to verification)
2. **TokenManager** - Now preserves group IDs from recorder:
   - `fork_token()`: `fork_group_id=child.fork_group_id`
   - `coalesce_tokens()`: `join_group_id=merged.join_group_id`
   - `expand_token()`: `expand_group_id=db_child.expand_group_id`
3. **RowProcessor** - Now uses canonical group IDs from tokens:
   - Fork: `outcome.child_tokens[0].fork_group_id`
   - Expand: `child_tokens[0].expand_group_id`
4. **CoalesceExecutor** - Uses `merged_token.join_group_id`

### Why Previous Verifications Said "Still Valid"

A **secondary bug** in commit `a4a8eed` masked the fix:

- `TransformProtocol` incorrectly required `routes` and `fork_to` attributes
- This caused `isinstance(transform, TransformProtocol)` to return `False` for all transforms
- The expand tests failed with `TypeError: Unknown transform type` instead of testing group IDs
- Verifiers saw failing tests and concluded the original bug was unfixed

The secondary bug was fixed by removing `routes` and `fork_to` from `TransformProtocol` (they belong only on `GateProtocol`).

### Test Results (Post-Fix)

All 7 group ID consistency tests now pass:
- `test_fork_children_share_same_fork_group_id_in_tokens_table` ✓
- `test_fork_parent_outcome_uses_canonical_fork_group_id` ✓
- `test_coalesce_creates_merged_token_with_join_group_id` ✓
- `test_coalesce_consumed_tokens_use_canonical_join_group_id` ✓
- `test_coalesce_merged_token_outcome_uses_canonical_join_group_id` ✓
- `test_expand_creates_consistent_group_id_across_all_children` ✓
- `test_expand_parent_outcome_uses_canonical_expand_group_id` ✓

### Lesson Learned

**Defensive programming can hide bugs.** The `isinstance()` check against a malformed protocol silently rejected valid transforms instead of letting the code run and either succeed or fail with a meaningful error.
