# Bug Triage Report - 2026-02-05

## Executive Summary

Triaged **203 bug reports** from the 2026-02-05 static analysis run. These bugs were generated by automated code review (Codex/GPT-5) analyzing the ELSPETH codebase for violations of architectural invariants, data integrity requirements, and coding standards.

### Key Findings

| Metric | Value |
|--------|-------|
| **Total Bugs Triaged** | 203 |
| **P1 (Major - Audit/Data Integrity)** | 54 (27%) |
| **P2 (Moderate - Functionality Gaps)** | 72 (35%) |
| **P3 (Minor - Quality/UX)** | 77 (38%) |
| **P0 (Critical - System Down)** | 0 |
| **False Positives Identified** | 0 (requires verification) |
| **Duplicates with Closed Bugs** | 0 |

### Critical Hotspots

1. **core-landscape** (10 P1 bugs): Audit trail repositories lack validation for corrupted Tier-1 data
2. **plugins-llm** (7 P1 bugs): HTTP client and LLM transforms have call recording gaps
3. **plugins-transforms** (7 P1 bugs): Contract propagation issues, capacity error handling
4. **contracts** (5 P1 bugs): Schema contract locking, type normalization failures
5. **engine-orchestrator** (4 P1 bugs): Resume path has legacy code, quarantine hashing can crash

## Triage Process

### Source
- **Input**: 188 markdown files in `docs/bugs/generated/elspeth/`
- **Method**: Automated extraction of bug reports (some files contained multiple bugs separated by `---`)
- **Output**: 203 bug tickets created in `docs/bugs/open/{subsystem}/`

### Classification Criteria

| Priority | Criteria |
|----------|----------|
| **P0** | System down, production broken, cannot run pipelines |
| **P1** | Audit trail integrity issues, data corruption, security violations |
| **P2** | Functionality gaps, features not working as documented |
| **P3** | Quality issues, UX problems, minor inconsistencies |

### Subsystem Mapping

Source files were mapped to subsystems based on their location in the codebase:
- `src/elspeth/core/landscape/` -> `core-landscape`
- `src/elspeth/engine/executors.py` -> `engine-executors`
- `src/elspeth/plugins/llm/` -> `plugins-llm`
- etc.

## Detailed Analysis by Subsystem

### core-landscape (19 bugs: 10 P1, 6 P2, 3 P3)

**Critical Issues (P1):**
1. **NodeStateRepository allows invalid OPEN/PENDING rows** - Missing validation for forbidden NULL fields
2. **Routing reason payloads never persisted** - `reason_ref` always NULL in routing_events
3. **Payload store skips integrity check for existing payloads** - Could accept corrupted data
4. **DatabaseOps ignores affected row count** - Silent audit table write failures
5. **SQLite schema validation misses new columns** - Schema drift not detected
6. **Audit export drops NodeState context/error** - Incomplete exports
7. **explain() allows missing parent relationships** - Lineage queries can return incomplete data
8. **IO_READ/IO_WRITE nodes misclassified** - Reproducibility grading incorrect
9. **compute_grade accepts invalid determinism** - Silent failures in grading
10. **Operation status completed on BaseException** - KeyboardInterrupt marks as success

**Root Cause Pattern**: Repository and recorder code lacks Tier-1 crash-on-corruption behavior required by the Data Manifesto.

### plugins-llm (22 bugs: 7 P1, 10 P2, 5 P3)

**Critical Issues (P1):**
1. **HTTP client accepts NaN/Infinity in JSON** - Breaks call recording
2. **CallVerifier skips hash verification when purged** - Integrity check bypassed
3. **Azure Batch crashes on aggregation flush** - dict/PipelineRow mismatch
4. **Azure Multi-Query drops dual-name resolution** - Original headers lost
5. **OpenRouter Batch drops `/api/v1` from URL** - Wrong API endpoint
6. **OpenRouter multi-query output key collisions** - Silent overwrites
7. **LLM JSON validator accepts NaN/Infinity** - Violates canonical JSON

**Root Cause Pattern**: PipelineRow migration incomplete in LLM transforms, external call handling inconsistent.

### plugins-transforms (29 bugs: 7 P1, 14 P2, 8 P3)

**Critical Issues (P1):**
1. **FieldMapper drops original field names** - Contract breaks dual-name access
2. **BatchStats silently drops group_by field** - Should fail fast
3. **KeywordFilter ignores PipelineRow resolution** - Original names don't work
4. **CapacityError crashes Content Safety** - Pooled executor never used
5. **CapacityError crashes PromptShield** - Same pattern as Content Safety
6. **get_nested_field hides type mismatches** - Reports "missing" instead of "wrong type"
7. **PluginConfigValidator rejects valid transforms** - OpenRouter batch/multi-query blocked

**Root Cause Pattern**: PipelineRow dual-name access not consistently implemented, error handling converts crashes to silent failures.

### contracts (31 bugs: 5 P1, 11 P2, 15 P3)

**Critical Issues (P1):**
1. **RoutingAction accepts non-enum mode** - TypeError later, leaves node state OPEN
2. **Batch trigger_type bypasses TriggerType validation** - String instead of enum
3. **FLEXIBLE contracts locked at creation** - Blocks infer-and-lock behavior
4. **Missing-value sentinels not normalized** - pd.NA, np.datetime64("NaT") slip through
5. **SanitizedWebhookUrl leaves fragments unredacted** - Potential token leakage

**Root Cause Pattern**: Contract validation gaps at construction time; issues manifest later in pipeline execution.

### engine-orchestrator (9 bugs: 4 P1, 2 P2, 3 P3)

**Critical Issues (P1):**
1. **Resume silently infers missing run contract** - Violates Tier-1 trust + no-legacy policy
2. **Quarantined row telemetry hash crashes on NaN** - Should use repr_hash fallback
3. **Resume fails for observed schemas** - Empty properties rejection
4. **Condition-based aggregation triggers ignored** - Pre-row flush doesn't check conditions

**Root Cause Pattern**: Resume path has legacy compatibility code that should be removed per no-legacy policy.

### plugins-azure (7 bugs: 3 P1, 3 P2, 1 P3)

**Critical Issues (P1):**
1. **CSV malformed lines silently dropped** - `on_bad_lines="warn"` skips without audit
2. **JSON array errors crash instead of quarantine** - Should follow quarantine pattern
3. **AzureBlobSink overwrites prior batches** - Repeated write() clobbers data

**Root Cause Pattern**: Azure plugins don't follow same error handling patterns as non-Azure equivalents.

### engine-executors (4 bugs: 2 P1, 1 P2, 1 P3)

**Critical Issues (P1):**
1. **TransformExecutor drops input contract** - Creates new contract, loses original headers
2. **GateExecutor stable_hash failure leaves OPEN state** - No error handling around hash

**Root Cause Pattern**: Contract propagation doesn't match migration plan specification.

## Verification Notes

### Sample Verification Performed

1. **RoutingAction enum validation (contracts/routing.py)**: VALID - `__post_init__` checks invariants but not type
2. **TransformExecutor contract fallback (engine/executors.py)**: VALID - Uses `output_schema` instead of preserving input contract per migration plan
3. **GateExecutor hash error handling (engine/executors.py)**: VALID - `stable_hash(result.row)` at line 620 is outside try/except

### Potential False Positive Patterns

Some bugs may be false positives if:
- Python runtime type checking would catch the issue (dataclass doesn't enforce types)
- Code has been updated since the static analysis was run
- The static analysis misunderstood the intended behavior

**Recommendation**: Verify P1 bugs against current code before fixing.

## Recommended Actions

### Immediate (This Sprint)

1. **Verify P1 bugs**: Check each P1 bug against current code to confirm validity
2. **Fix core-landscape P1s first**: These are audit trail integrity issues
3. **Address contract validation gaps**: Add explicit type checking in `__post_init__`
4. **Update TransformExecutor**: Preserve input contract per migration plan

### Next Sprint

1. **Complete PipelineRow migration**: Ensure all transforms use dual-name access correctly
2. **Standardize Azure plugin error handling**: Match non-Azure patterns
3. **Add telemetry validation tests**: Ensure NaN/Infinity handling is consistent

### Backlog

1. **P3 quality improvements**: Observability, testing infrastructure
2. **Documentation updates**: Ensure error handling patterns are documented

## Files Created

All bug tickets created in `docs/bugs/open/{subsystem}/` with naming convention:
```
{PRIORITY}-{DATE}-{SHORT-DESCRIPTION}.md
```

Example: `P1-2026-02-05-routingaction-accepts-non-enum-mode.md`

## Metrics for Tracking

| Metric | Target | Current |
|--------|--------|---------|
| Open P1 bugs | 0 | 54 |
| Open P2 bugs | < 20 | 72 |
| P1 bugs per subsystem | < 3 | core-landscape: 10, plugins-llm: 7 |
| Bug escape rate | < 10% | N/A (pre-release) |

## Appendix: Full P1 Bug List

### contracts (5 P1)
1. Batch trigger_type bypasses TriggerType enum validation
2. RoutingAction accepts non-enum mode causing TypeError
3. FLEXIBLE contracts locked at creation, blocking infer-and-lock
4. Missing-value sentinels not normalized to None
5. SanitizedWebhookUrl leaves fragment tokens unredacted

### core-checkpoint (2 P1)
1. CheckpointManager cannot serialize datetime in aggregation state
2. Resume reprocesses buffered rows already in checkpoint state

### core-config (1 P1)
1. Gate route labels lowercased during config normalization

### core-dag (1 P1)
1. Pass-through nodes drop computed schema contracts

### core-landscape (10 P1)
1. DatabaseOps ignores affected row count
2. SQLite schema validation misses new columns
3. Audit export drops NodeState context/error
4. explain() allows missing parent relationships
5. Routing reason payloads never persisted
6. NodeStateRepository allows invalid OPEN/PENDING rows
7. compute_grade accepts invalid determinism values
8. IO_READ/IO_WRITE nodes misclassified as FULL_REPRODUCIBLE
9. Operation status completed on BaseException
10. FilesystemPayloadStore skips integrity check

### core-retention (1 P1)
1. Operation input/output payloads never purged

### core-security (1 P1)
1. Key Vault secrets load without fingerprint key

### engine-coalesce (1 P1)
1. Late-arrival coalesce failures miss outcome recording

### engine-executors (2 P1)
1. TransformExecutor drops input contract
2. GateExecutor stable_hash failure leaves node state OPEN

### engine-orchestrator (4 P1)
1. Resume silently infers missing run contract
2. Quarantined row telemetry hash can crash
3. Resume fails for observed schemas
4. Condition-based aggregation triggers ignored

### engine-pooling (1 P1)
1. BatchTransformMixin shares mutable PluginContext across threads

### engine-processor (1 P1)
1. Deaggregation crashes when TransformResult.rows are PipelineRow

### engine-triggers (1 P1)
1. Condition trigger not latched once fired

### mcp (1 P1)
1. query() read-only guard allows non-SELECT operations

### plugins-azure (3 P1)
1. CSV malformed lines silently dropped
2. JSON array errors crash instead of quarantine
3. AzureBlobSink overwrites prior batches

### plugins-llm (7 P1)
1. Non-finite JSON values break HTTP call recording
2. CallVerifier skips hash verification when purged
3. Azure Batch crashes on aggregation flush
4. Azure Multi-Query drops PipelineRow resolution
5. OpenRouter Batch drops /api/v1 from URL
6. OpenRouter multi-query output key collisions
7. LLM JSON validator accepts NaN/Infinity

### plugins-sinks (3 P1)
1. CSVSink writes blank values for required fields
2. DatabaseSink fails after validate_output_target
3. JSON array mode ignores mode=append

### plugins-sources (2 P1)
1. Duplicate raw headers not detected
2. NullSourceSchema breaks resume graph validation

### plugins-transforms (7 P1)
1. BatchStats silently drops group_by field
2. FieldMapper renames drop original field names
3. KeywordFilter ignores PipelineRow resolution
4. CapacityError crashes Content Safety
5. CapacityError crashes PromptShield
6. get_nested_field hides type mismatches
7. PluginConfigValidator rejects valid transforms

**Total P1 bugs: 54**
