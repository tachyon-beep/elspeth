# Bug Report: Token outcome group IDs do not match token lineage group IDs

## Summary

- RowProcessor generates new UUIDs for `fork_group_id`, `expand_group_id`, and `join_group_id` when recording token outcomes. These IDs do not match the group IDs generated by LandscapeRecorder when creating forked/expanded/coalesced tokens, so audit lineage cannot be correlated across tables.

## Severity

- Severity: major
- Priority: P1

## Reporter

- Name or handle: Codex
- Date: 2026-01-21
- Related run/issue ID: N/A

## Environment

- Commit/branch: ae2c0e6 / fix/rc1-bug-burndown-session-2
- OS: Linux
- Python version: Python 3.13.1
- Config profile / env vars: N/A
- Data set or fixture: N/A

## Agent Context (if relevant)

- Goal or task prompt: Deep dive src/elspeth/engine/processor.py for bugs; create reports.
- Model/version: GPT-5 (Codex CLI)
- Tooling and permissions (sandbox/approvals): workspace-write, no escalations
- Determinism details (seed, run ID): N/A
- Notable tool calls or steps: Code inspection only

## Steps To Reproduce

1. Run a pipeline that includes:
   - A gate fork (`fork_to_paths`)
   - A multi-row transform (`success_multi`) to trigger expansion
   - A coalesce merge
2. Inspect `tokens.*_group_id` and `token_outcomes.*_group_id` values.

## Expected Behavior

- `token_outcomes.fork_group_id` matches `tokens.fork_group_id` for forked tokens.
- `token_outcomes.expand_group_id` matches `tokens.expand_group_id` for expanded tokens.
- `token_outcomes.join_group_id` matches `tokens.join_group_id` for coalesced tokens.

## Actual Behavior

- Token outcomes use unrelated UUIDs, so group IDs cannot be correlated across audit tables.

## Evidence

- RowProcessor generates new IDs:
  - Fork: `src/elspeth/engine/processor.py:717-724`
  - Expand: `src/elspeth/engine/processor.py:851-858`
  - Coalesce: `src/elspeth/engine/processor.py:981-988`
- Recorder generates different group IDs when creating tokens:
  - `src/elspeth/core/landscape/recorder.py:820-872` (fork)
  - `src/elspeth/core/landscape/recorder.py:866-919` (coalesce)
  - `src/elspeth/core/landscape/recorder.py:934-982` (expand)

## Impact

- User-facing impact: Lineage reports cannot reliably connect token outcomes to fork/expand/coalesce groups.
- Data integrity / security impact: Audit trail violates traceability guarantees.
- Performance or cost impact: None directly.

## Root Cause Hypothesis

- Token group IDs are generated in the recorder but not propagated to RowProcessor, which generates its own IDs.

## Proposed Fix

- Code changes (modules/files): `src/elspeth/engine/processor.py`, `src/elspeth/engine/tokens.py` (expose group IDs), possibly `src/elspeth/core/landscape/recorder.py` to return IDs.
- Config or schema changes: None
- Tests to add/update: Add tests asserting outcome group IDs match token group IDs for fork/expand/coalesce.
- Risks or migration steps: None (fix is internal linkage).

## Architectural Deviations

- Spec or doc reference (e.g., docs/design/architecture.md#L...): `docs/design/subsystems/00-overview.md` (fork/join group IDs for tokens).
- Observed divergence: Outcome group IDs do not line up with token group IDs.
- Reason (if known): Group IDs not exposed to processor.
- Alignment plan or decision needed: Decide canonical source for group IDs and propagate consistently.

## Acceptance Criteria

- Group IDs recorded in `token_outcomes` match those stored on tokens.
- Tests validate linkage for fork/expand/coalesce.

## Tests

- Suggested tests to run: `pytest tests/engine/test_processor.py -k group_id`
- New tests required: Yes (group ID linkage).

## Notes / Links

- Related issues/PRs: N/A
- Related design docs: `docs/design/subsystems/00-overview.md`
