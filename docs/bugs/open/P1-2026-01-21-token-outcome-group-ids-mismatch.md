# Bug Report: Token outcomes use synthetic fork/join/expand group IDs that don't match tokens table

## Summary

- `LandscapeRecorder` generates and stores `fork_group_id`, `join_group_id`, and `expand_group_id` on token records when forking/coalescing/expanding.
- `TokenManager` discards those group IDs when returning `TokenInfo`, and `RowProcessor` generates new random IDs when recording token outcomes.
- As a result, `token_outcomes.{fork,join,expand}_group_id` does not match the group IDs recorded on the tokens themselves, breaking lineage grouping and audit consistency.

## Severity

- Severity: major
- Priority: P1

## Reporter

- Name or handle: codex
- Date: 2026-01-21
- Related run/issue ID: N/A

## Environment

- Commit/branch: `ae2c0e6f088f467276582fa8016f91b4d3bb26c7` (local)
- OS: Linux (Ubuntu kernel 6.8.0-90-generic)
- Python version: 3.13.1
- Config profile / env vars: N/A
- Data set or fixture: N/A

## Agent Context (if relevant)

- Goal or task prompt: deep dive into `src/elspeth/engine/tokens.py` and create bug tickets
- Model/version: GPT-5 (Codex CLI)
- Tooling and permissions (sandbox/approvals): workspace-write, network restricted, approvals on-request
- Determinism details (seed, run ID): N/A
- Notable tool calls or steps: static inspection of token manager, recorder, and row processor

## Steps To Reproduce

1. Run a pipeline that includes a fork (gate) or a transform that returns `TransformResult.success_multi()`.
2. Inspect `tokens` and `token_outcomes` tables for the affected token.
3. Observe that `tokens.fork_group_id` / `tokens.expand_group_id` / `tokens.join_group_id` do not match the corresponding fields in `token_outcomes`.

## Expected Behavior

- `token_outcomes.{fork,join,expand}_group_id` should match the group IDs recorded on tokens created by the recorder.

## Actual Behavior

- Token outcomes use fresh random IDs unrelated to the token group IDs generated by `LandscapeRecorder`.

## Evidence

- `LandscapeRecorder.fork_token()`/`coalesce_tokens()`/`expand_token()` generate and store group IDs on tokens: `src/elspeth/core/landscape/recorder.py`.
- `TokenManager` returns `TokenInfo` without group IDs, dropping the recorder values: `src/elspeth/engine/tokens.py`.
- `RowProcessor` generates new UUIDs for token outcomes:
  - Fork: `src/elspeth/engine/processor.py` (random `fork_group_id`)
  - Expand: `src/elspeth/engine/processor.py` (random `expand_group_id`)
  - Coalesce: `src/elspeth/engine/processor.py` (random `join_group_id`)

## Impact

- User-facing impact: lineage grouping for forks/expands/coalesces is inconsistent between token records and outcomes.
- Data integrity / security impact: audit trail cannot reliably correlate outcome grouping with actual token lineage; violates traceability expectations.
- Performance or cost impact: low.

## Root Cause Hypothesis

- Group IDs are generated in the recorder but are not exposed through `TokenInfo`, forcing the processor to invent new IDs for outcome recording.

## Proposed Fix

- Code changes (modules/files):
  - Extend `TokenInfo` to include `fork_group_id`, `join_group_id`, and `expand_group_id`.
  - Update `TokenManager.fork_token()` / `coalesce_tokens()` / `expand_token()` to populate these fields from recorder-returned `Token` objects.
  - Update `RowProcessor` to use these group IDs when calling `record_token_outcome()`.
- Config or schema changes: none.
- Tests to add/update:
  - Add an integration test that creates forked/expanded/coalesced tokens and asserts `token_outcomes` group IDs match `tokens` group IDs.
- Risks or migration steps:
  - Ensure any existing reports or exporters referencing token outcomes account for the corrected IDs.

## Architectural Deviations

- Spec or doc reference (e.g., docs/design/architecture.md#L...): `docs/design/subsystems/00-overview.md` (group IDs link tokens from the same fork/coalesce/expand).
- Observed divergence: token outcomes do not use the recorder-generated group IDs.
- Reason (if known): `TokenInfo` does not carry group IDs, so processor synthesizes them.
- Alignment plan or decision needed: decide canonical source for group IDs (tokens table) and propagate into outcomes.

## Acceptance Criteria

- For any fork/coalesce/expand, the group IDs recorded in `token_outcomes` match the group IDs stored on tokens.

## Tests

- Suggested tests to run: `.venv/bin/python -m pytest tests/engine/test_processor_outcomes.py -k group_id`
- New tests required: yes (group ID consistency)

## Notes / Links

- Related issues/PRs: N/A
- Related design docs: `docs/design/subsystems/00-overview.md`
