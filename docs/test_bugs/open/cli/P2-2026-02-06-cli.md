# Test Bug Report: Fix weak assertions in cli

## Summary

- This is a well-structured CLI integration test file covering run, purge, resume, and tilde expansion commands. Most tests are genuine integration tests that exercise real code paths through the CLI runner. However, there are some inefficiencies with duplicated setup code and a few tests that have weak assertions.

## Severity

- Severity: trivial
- Priority: P2
- Verdict: **KEEP**

## Reporter

- Name or handle: Test Audit
- Date: 2026-02-06
- Audit file: docs/test_audit/tests_cli_test_cli.py.audit.md

## Test File

- **File:** `tests/cli/test_cli.py`
- **Lines:** 1039
- **Test count:** 24

## Findings

- **Line 21-25:**: `test_cli_exists` is trivial - merely asserting that an import succeeds and returns non-None. This provides minimal value since any syntax error would already fail at import time during test collection.
- **Line 52-110:**: `test_transforms_from_config_are_instantiated` and `test_field_mapper_transform_modifies_output` (lines 112-176) both create nearly identical YAML configs with minor variations. These could be parameterized to reduce duplication.
- **Line 351-352:**: `test_purge_with_yes_flag_skips_confirmation` has a weak assertion: `assert "confirm" not in result.stdout.lower() or "yes" in result.stdout.lower()` - this OR condition could pass even if confirmation was asked (as long as "yes" appears anywhere in output). The test name claims it "skips confirmation" but the assertion doesn't verify that behavior strongly.
- **Line 433-434:**: `test_purge_with_payloads_to_delete` assertion `assert "deleted" in result.stdout.lower() or "1" in result.stdout` - checking for "1" anywhere in stdout is fragile and could match timestamps, IDs, or version numbers.
- **Line 594-596:**: `test_resume_nonexistent_run` asserts `"not found" in output or "error" in output` - this is overly broad. "error" could match many unrelated strings and doesn't verify the specific failure mode.
- **Line 667-669:**: `test_resume_completed_run` and `test_resume_running_run` (lines 740-742) both have similar weak OR-based assertions that don't precisely verify the expected error behavior.
- **Line 54-58, 114-118:**: Redundant reimport of `CliRunner` and `app` within test methods when module-level `runner` already exists. This adds unnecessary noise.
- **Line 49:**: `TestRunCommandExecutesTransforms` class has only 2 tests. Consider whether there are additional transform execution scenarios worth covering (e.g., multiple transforms, transform error handling).
- **Line 179:**: `TestPurgeCommand` class is comprehensive with 9 tests covering dry-run, retention override, confirmation, payload deletion, config loading, and unsupported backends. Good coverage.
- **Line 520:**: `TestResumeCommand` class has 7 tests covering various failure modes (nonexistent run, completed run, running run, no checkpoint) and success case. Well structured.
- **Line 788-959:**: `test_resume_shows_resume_point_info` is a complex 170-line test. While thorough, it builds a lot of infrastructure (graph, nodes, tokens, checkpoint) that could potentially be extracted into fixtures if more resume tests are added.
- **Line 962-1039:**: `TestTildeExpansion` tests use `patch.object(Path, "expanduser")` which is appropriate for testing path expansion behavior without requiring actual home directory access. Good isolation approach.
- **Line 440-517:**: The two purge config tests (`test_purge_uses_config_payload_store_settings` and `test_purge_rejects_unsupported_backend`) use `monkeypatch.chdir(tmp_path)` appropriately to test config file discovery.


## Verdict Detail

**KEEP** - This is a solid CLI integration test suite with real value. The tests exercise actual code paths through the CLI runner and verify end-to-end behavior. The issues identified are minor inefficiencies and some weak assertions that could be tightened but don't fundamentally undermine the test suite's utility.

## Proposed Fix

- [ ] Weak assertions strengthened
- [ ] Redundant tests consolidated
- [ ] Test intent clearly expressed in assertions

## Tests

- Run after fix: `.venv/bin/python -m pytest tests/cli/test_cli.py -v`

## Notes

- Source audit: `docs/test_audit/tests_cli_test_cli.py.audit.md`
