# Mutation Testing Workflow
# Runs weekly to validate test effectiveness - mutation testing is slow so not run on every PR
#
# Mutation testing introduces artificial bugs (mutants) into the code and checks if tests catch them.
# A high mutation score means tests actually verify behavior, not just execute code.
#
# Target mutation scores:
#   - canonical.py: 95%+ (hash integrity is foundational)
#   - landscape/: 90%+ (audit trail is the legal record)
#   - engine/: 85%+ (orchestration correctness)

name: Mutation Testing

on:
  schedule:
    # Weekly on Sunday at 2 AM UTC
    - cron: '0 2 * * 0'
  workflow_dispatch:
    # Allow manual triggering for ad-hoc runs
    inputs:
      paths_to_mutate:
        description: 'Specific path to mutate (default: src/elspeth/core/)'
        required: false
        default: 'src/elspeth/core/canonical.py'

jobs:
  mutation-test:
    runs-on: ubuntu-latest
    timeout-minutes: 60  # Mutation testing is slow

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install uv
        run: pip install uv

      - name: Install dependencies
        run: |
          uv venv
          source .venv/bin/activate
          uv pip install -e ".[dev]"

      - name: Run mutation testing on canonical.py (critical)
        run: |
          source .venv/bin/activate
          echo "## Mutation Testing: canonical.py" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Run mutmut on canonical.py - the hash integrity module
          python -m mutmut run --paths-to-mutate src/elspeth/core/canonical.py || true

          # Capture results
          echo "### Results" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          python -m mutmut results 2>/dev/null || echo "Results summary not available"
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Check canonical.py mutation score
        run: |
          source .venv/bin/activate
          # Count killed vs total
          KILLED=$(cat .mutmut-cache/mutmut.db 2>/dev/null | grep -c "killed" || echo "0")
          TOTAL=$(cat .mutmut-cache/mutmut.db 2>/dev/null | grep -c "mutant" || echo "1")

          # Basic threshold check (95% target for canonical)
          # Note: Actual scoring would require parsing mutmut output
          echo "Mutation testing completed for canonical.py"

      - name: Upload mutation results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: mutation-results
          path: |
            .mutmut-cache/
          retention-days: 30

  mutation-test-landscape:
    runs-on: ubuntu-latest
    timeout-minutes: 120  # Landscape has more code
    if: github.event_name == 'schedule'  # Only run on schedule, not manual dispatch

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install uv
        run: pip install uv

      - name: Install dependencies
        run: |
          uv venv
          source .venv/bin/activate
          uv pip install -e ".[dev]"

      - name: Run mutation testing on landscape recorder
        run: |
          source .venv/bin/activate
          echo "## Mutation Testing: landscape/recorder.py" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          python -m mutmut run --paths-to-mutate src/elspeth/core/landscape/recorder.py || true

          echo "### Results" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          python -m mutmut results 2>/dev/null || echo "Results summary not available"
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Upload mutation results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: mutation-results-landscape
          path: |
            .mutmut-cache/
          retention-days: 30
